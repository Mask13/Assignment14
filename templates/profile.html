{% extends "layout.html" %}
{% block title %}My Profile{% endblock %}

{% block content %}
<!-- Error/Success Alerts -->
<div 
  id="errorAlert" 
  class="hidden bg-red-100 border border-red-500 text-red-800 
         px-4 py-3 rounded-md mb-4 transition-all duration-300"
>
  <div class="flex items-center">
    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
    </svg>
    <span id="errorMessage" class="block sm:inline"></span>
  </div>
</div>
<div 
  id="successAlert" 
  class="hidden bg-green-100 border border-green-500 text-green-800 
         px-4 py-3 rounded-md mb-4 transition-all duration-300"
>
  <div class="flex items-center">
    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
    </svg>
    <span id="successMessage" class="block sm:inline"></span>
  </div>
</div>

<!-- Breadcrumbs -->
<nav class="flex mb-4" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 md:space-x-3">
    <li class="inline-flex items-center">
      <a href="/dashboard" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
        </svg>
        Dashboard
      </a>
    </li>
    <li>
      <div class="flex items-center">
        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
        </svg>
        <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Profile</span>
      </div>
    </li>
  </ol>
</nav>

<!-- Page Header -->
<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-900 flex items-center">
    <svg class="w-8 h-8 mr-3 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
    </svg>
    My Profile
  </h1>
  <p class="mt-2 text-gray-600">Manage your account information and security settings</p>
</div>

<!-- Profile Information Card -->
<div class="bg-white shadow-lg rounded-lg mb-6 p-6 transition-all duration-300 hover:shadow-xl border border-gray-100">
  <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
    <svg class="w-5 h-5 mr-2 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
    </svg>
    Profile Information
  </h2>
  
  <form id="profileForm" class="space-y-5">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <!-- First Name -->
      <div>
        <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
          First Name
        </label>
        <input 
          type="text" 
          id="firstName" 
          name="first_name" 
          required
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 border"
          placeholder="John"
        />
      </div>
      
      <!-- Last Name -->
      <div>
        <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
          Last Name
        </label>
        <input 
          type="text" 
          id="lastName" 
          name="last_name" 
          required
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 border"
          placeholder="Doe"
        />
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
      <!-- Username -->
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">
          Username
        </label>
        <input 
          type="text" 
          id="username" 
          name="username" 
          required
          minlength="3"
          maxlength="50"
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 border"
          placeholder="johndoe"
        />
      </div>
      
      <!-- Email -->
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
          Email
        </label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          required
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 border"
          placeholder="john.doe@example.com"
        />
      </div>
    </div>
    
    <!-- Account Info (Read-only) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 pt-4 border-t">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Account Status
        </label>
        <p id="accountStatus" class="text-sm text-gray-600 py-2"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Member Since
        </label>
        <p id="memberSince" class="text-sm text-gray-600 py-2"></p>
      </div>
    </div>
    
    <div class="pt-2">
      <button 
        type="submit" 
        class="bg-blue-700 text-white px-6 py-2 
               rounded-md hover:bg-blue-800 transition-colors duration-200
               focus:outline-none focus:ring-2 focus:ring-offset-2 
               focus:ring-blue-500 font-medium flex items-center"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Update Profile
      </button>
    </div>
  </form>
</div>

<!-- Change Password Card -->
<div class="bg-white shadow-lg rounded-lg p-6 transition-all duration-300 hover:shadow-xl border border-gray-100">
  <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
    <svg class="w-5 h-5 mr-2 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
    </svg>
    Change Password
  </h2>
  
  <form id="passwordForm" class="space-y-5">
    <!-- Current Password -->
    <div>
      <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">
        Current Password
      </label>
      <div class="relative">
        <input 
          type="password" 
          id="currentPassword" 
          name="current_password" 
          required
          minlength="8"
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 pr-10 border"
          placeholder="Enter your current password"
        />
        <button 
          type="button" 
          onclick="togglePassword('currentPassword')"
          class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-600 hover:text-gray-800"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- New Password -->
    <div>
      <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">
        New Password
      </label>
      <div class="relative">
        <input 
          type="password" 
          id="newPassword" 
          name="new_password" 
          required
          minlength="8"
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 pr-10 border"
          placeholder="Enter your new password"
        />
        <button 
          type="button" 
          onclick="togglePassword('newPassword')"
          class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-600 hover:text-gray-800"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
      <p class="mt-1 text-xs text-gray-500">
        Password must be at least 8 characters with uppercase, lowercase, digit, and special character
      </p>
    </div>
    
    <!-- Confirm New Password -->
    <div>
      <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">
        Confirm New Password
      </label>
      <div class="relative">
        <input 
          type="password" 
          id="confirmNewPassword" 
          name="confirm_new_password" 
          required
          minlength="8"
          class="block w-full rounded-md border-gray-300 shadow-sm 
                 focus:border-blue-500 focus:ring-blue-500 py-2 px-3 pr-10 border"
          placeholder="Confirm your new password"
        />
        <button 
          type="button" 
          onclick="togglePassword('confirmNewPassword')"
          class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-600 hover:text-gray-800"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="pt-2">
      <button 
        type="submit" 
        class="bg-green-600 text-white px-6 py-2 
               rounded-md hover:bg-green-700 transition-colors duration-200
               focus:outline-none focus:ring-2 focus:ring-offset-2 
               focus:ring-green-500 font-medium flex items-center"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
        </svg>
        Change Password
      </button>
    </div>
  </form>
</div>

<!-- Delete Account Section (Optional - could be added later) -->
<div class="bg-red-50 border-2 border-red-200 rounded-lg p-6 mt-6">
  <h3 class="text-lg font-semibold text-red-800 mb-2 flex items-center">
    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
    </svg>
    Danger Zone
  </h3>
  <p class="text-sm text-red-700 mb-3">
    Once you delete your account, there is no going back. All your calculations will be permanently deleted.
  </p>
  <button 
    type="button"
    onclick="alert('Account deletion feature coming soon!')"
    class="bg-red-600 text-white px-4 py-2 
           rounded-md hover:bg-red-700 transition-colors duration-200
           focus:outline-none focus:ring-2 focus:ring-offset-2 
           focus:ring-red-500 font-medium text-sm"
  >
    Delete My Account
  </button>
</div>

<script>
  // Toggle password visibility
  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    field.type = field.type === 'password' ? 'text' : 'password';
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const token = localStorage.getItem('access_token');
    if (!token) {
      window.location.href = '/login';
      return;
    }

    // Display welcome message in layout nav
    const username = localStorage.getItem('username') || "User";
    const layoutWelcome = document.getElementById('layoutUserWelcome');
    if (layoutWelcome) layoutWelcome.textContent = `Welcome, ${username}!`;

    // Attach logout logic
    const layoutLogoutBtn = document.getElementById('layoutLogoutBtn');
    if (layoutLogoutBtn) {
      layoutLogoutBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
          localStorage.clear();
          window.location.href = '/login';
        }
      });
    }

    // Alert helper functions
    function showError(msg) {
      const errorAlert = document.getElementById('errorAlert');
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = msg;
      errorAlert.classList.remove('hidden');
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        errorAlert.classList.add('opacity-0');
        setTimeout(() => {
          errorAlert.classList.add('hidden');
          errorAlert.classList.remove('opacity-0');
        }, 300);
      }, 5000);
      
      // Scroll to top to show error
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showSuccess(msg) {
      const successAlert = document.getElementById('successAlert');
      const successMessage = document.getElementById('successMessage');
      successMessage.textContent = msg;
      successAlert.classList.remove('hidden');
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        successAlert.classList.add('opacity-0');
        setTimeout(() => {
          successAlert.classList.add('hidden');
          successAlert.classList.remove('opacity-0');
        }, 300);
      }, 5000);
      
      // Scroll to top to show success message
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Load current user profile
    async function loadProfile() {
      try {
        const response = await fetch('/users/me', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          throw new Error('Failed to load profile');
        }

        const user = await response.json();
        
        // Populate form fields
        document.getElementById('firstName').value = user.first_name;
        document.getElementById('lastName').value = user.last_name;
        document.getElementById('username').value = user.username;
        document.getElementById('email').value = user.email;
        
        // Display account info
        document.getElementById('accountStatus').textContent = user.is_active ? 
          '✓ Active' : '✗ Inactive';
        document.getElementById('accountStatus').className = user.is_active ?
          'text-sm text-green-600 font-medium py-2' : 'text-sm text-red-600 font-medium py-2';
        
        const createdDate = new Date(user.created_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        document.getElementById('memberSince').textContent = createdDate;
        
      } catch (error) {
        showError(error.message || 'Error loading profile');
      }
    }

    // Handle profile update form submission
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonContent = submitButton.innerHTML;

      const profileData = {
        first_name: document.getElementById('firstName').value.trim(),
        last_name: document.getElementById('lastName').value.trim(),
        username: document.getElementById('username').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      // Client-side validation
      if (!profileData.first_name || !profileData.last_name) {
        showError('First name and last name are required');
        return;
      }

      if (profileData.username.length < 3) {
        showError('Username must be at least 3 characters long');
        return;
      }

      // Show loading state
      submitButton.disabled = true;
      submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Updating...';

      try {
        const response = await fetch('/users/me/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(profileData)
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Failed to update profile');
        }

        const updatedUser = await response.json();
        
        // Update localStorage with new username
        localStorage.setItem('username', updatedUser.username);
        
        // Update welcome message
        if (layoutWelcome) layoutWelcome.textContent = `Welcome, ${updatedUser.username}!`;
        
        showSuccess('Profile updated successfully!');
        
        // Reload profile to reflect changes
        await loadProfile();

      } catch (error) {
        showError(error.message || 'Error updating profile');
      } finally {
        // Restore button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonContent;
      }
    });

    // Validate password strength
    function validatePasswordStrength(password) {
      const errors = [];
      
      if (password.length < 8) {
        errors.push('Password must be at least 8 characters long');
      }
      if (!/[A-Z]/.test(password)) {
        errors.push('Password must contain at least one uppercase letter');
      }
      if (!/[a-z]/.test(password)) {
        errors.push('Password must contain at least one lowercase letter');
      }
      if (!/[0-9]/.test(password)) {
        errors.push('Password must contain at least one digit');
      }
      if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) {
        errors.push('Password must contain at least one special character');
      }
      
      return errors;
    }

    // Handle password change form submission
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const form = e.target;
      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonContent = submitButton.innerHTML;

      const passwordData = {
        current_password: document.getElementById('currentPassword').value,
        new_password: document.getElementById('newPassword').value,
        confirm_new_password: document.getElementById('confirmNewPassword').value
      };

      // Client-side validation
      if (!passwordData.current_password) {
        showError('Current password is required');
        return;
      }

      if (passwordData.new_password !== passwordData.confirm_new_password) {
        showError('New passwords do not match');
        return;
      }

      if (passwordData.current_password === passwordData.new_password) {
        showError('New password must be different from current password');
        return;
      }

      // Validate password strength
      const validationErrors = validatePasswordStrength(passwordData.new_password);
      if (validationErrors.length > 0) {
        showError(validationErrors.join('. '));
        return;
      }

      // Show loading state
      submitButton.disabled = true;
      submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Changing...';

      try {
        const response = await fetch('/users/me/password', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(passwordData)
        });

        if (!response.ok) {
          if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login';
            return;
          }
          
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Failed to change password');
        }

        showSuccess('Password changed successfully! Please log in again with your new password.');
        
        // Clear the form
        form.reset();
        
        // Optionally logout after password change (recommended for security)
        setTimeout(() => {
          localStorage.clear();
          window.location.href = '/login';
        }, 3000);

      } catch (error) {
        showError(error.message || 'Error changing password');
      } finally {
        // Restore button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonContent;
      }
    });

    // Initial profile load
    loadProfile();
  });
</script>

<!-- Include profile-specific JS -->
<script src="{{ url_for('static', path='js/script.js') }}"></script>
{% endblock %}
